import { svgToDataURI } from '@/utils/svg'
import { expose } from 'comlink'
import satori, { init } from 'satori/wasm'
import initYoga from 'yoga-wasm-web'

let initialized = false

export const logo = svgToDataURI(
  `<svg viewBox="0 0 354 125" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M191.499 39.3239H184.679C183.794 39.3239 183.079 40.0385 183.079 40.924V48.5985C181.106 47.7596 178.947 47.2935 176.663 47.2935C167.606 47.2935 160.227 54.6573 160.227 63.73V65.9982C160.227 75.0553 167.59 82.4347 176.663 82.4347C178.947 82.4347 181.122 81.9686 183.11 81.1142C183.25 81.8599 183.903 82.4347 184.679 82.4347H191.499C192.385 82.4347 193.1 81.72 193.1 80.8345V65.9982V63.73V40.9395C193.1 40.054 192.385 39.3239 191.499 39.3239ZM176.663 72.4143C173.121 72.4143 170.247 69.5403 170.247 65.9982V63.73C170.247 60.1879 173.121 57.3139 176.663 57.3139C180.205 57.3139 183.079 60.1879 183.079 63.73V65.9982C183.079 69.5403 180.205 72.4143 176.663 72.4143Z" fill="white"/><path d="M207.923 82.4192H201.103C200.218 82.4192 199.503 81.7046 199.503 80.819V73.999C199.503 73.1135 200.218 72.3988 201.103 72.3988H207.923C208.809 72.3988 209.523 73.1135 209.523 73.999V80.819C209.523 81.7046 208.809 82.4192 207.923 82.4192Z" fill="white"/><path d="M263.57 39.3239H256.75C255.864 39.3239 255.149 40.0385 255.149 40.924V48.5985C253.176 47.7596 251.017 47.2936 248.733 47.2936C239.676 47.2936 232.297 54.6574 232.297 63.73V65.9982C232.297 75.0554 239.661 82.4347 248.733 82.4347C251.017 82.4347 253.192 81.9686 255.181 81.1142C255.32 81.8599 255.973 82.4347 256.75 82.4347H263.57C264.455 82.4347 265.17 81.7201 265.17 80.8346V40.9396C265.17 40.054 264.455 39.3239 263.57 39.3239ZM248.733 72.4144C245.191 72.4144 242.317 69.5403 242.317 65.9982V63.73C242.317 60.188 245.191 57.3139 248.733 57.3139C252.275 57.3139 255.149 60.188 255.149 63.73V65.9982C255.149 69.5403 252.275 72.4144 248.733 72.4144Z" fill="white"/><path d="M224.328 82.4212H217.508C216.623 82.4212 215.908 81.7066 215.908 80.821V54.5662C215.908 53.6806 216.623 52.966 217.508 52.966H224.328C225.214 52.966 225.929 53.6806 225.929 54.5662V80.8366C225.929 81.7066 225.214 82.4212 224.328 82.4212Z" fill="white"/><path d="M224.329 49.3455H217.509C216.624 49.3455 215.909 48.6309 215.909 47.7454V40.9408C215.909 40.0553 216.624 39.3407 217.509 39.3407H224.329C225.215 39.3407 225.929 40.0553 225.929 40.9408V47.7609C225.929 48.6309 225.215 49.3455 224.329 49.3455Z" fill="white"/><path d="M116.841 75.8453C129.067 75.8453 139.072 65.8405 139.072 53.5985C139.072 48.4874 137.519 44.0287 134.629 40.2536C137.301 38.2495 139.072 34.9094 139.072 31.3518H116.841C104.615 31.3518 94.6099 41.3566 94.6099 53.5985C94.6099 65.8405 104.615 75.8453 116.841 75.8453ZM116.841 41.5897C123.506 41.5897 128.85 46.9338 128.85 53.5985C128.85 60.2788 123.521 65.6074 116.841 65.6074C110.161 65.6074 104.832 60.2788 104.832 53.5985C104.832 46.9183 110.176 41.5897 116.841 41.5897Z" fill="#00DF9B"/><path d="M145.301 81.8566C143.965 78.5164 141.293 76.0774 137.736 74.9588C131.957 80.5205 124.406 83.4101 117.074 83.4101C109.508 83.4101 102.175 80.5205 96.3959 74.9588C92.8383 76.0774 90.1662 78.5164 88.8302 81.8566C96.3959 89.6398 106.618 93.648 116.841 93.648C127.078 93.648 137.301 89.6398 145.301 81.8566Z" fill="#2471FE"/></svg>`,
)

export async function generateBack(offset: number) {
  if (!initialized) {
    const wasm = await fetch(new URL('yoga-wasm-web/dist/yoga.wasm', import.meta.url)).then((res) =>
      res.arrayBuffer(),
    )
    const yoga = await initYoga(wasm)
    init(yoga)
    initialized = true
  }

  const fonts = await Promise.all(
    ['/Poppins-Bold.ttf'].map(async (url) => {
      const response = await fetch(url)
      return response.arrayBuffer()
    }),
  )
  const svg = await satori(
    <div
      style={{
        width: '100%',
        height: '100%',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        backgroundColor: 'black',
      }}
    >
      <img
        src={logo}
        alt='logo'
        style={{
          height: 600,
          width: 1416,
          objectFit: 'cover',
          marginTop: 1800 + offset,
        }}
      />
    </div>,
    {
      width: 1960,
      height: 3108,
      fonts: fonts?.map((data) => ({ name: 'Poppins', data })),
    },
  )
  return svg
}

expose(generateBack)
